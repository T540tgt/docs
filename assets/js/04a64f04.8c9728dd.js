"use strict";(self.webpackChunkdocs_oasis_io=self.webpackChunkdocs_oasis_io||[]).push([[5616],{6142:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>i,default:()=>p,frontMatter:()=>s,metadata:()=>c,toc:()=>h});var a=t(4848),o=t(8453),r=t(1470),l=t(9365);const s={},i="Build",c={id:"dapp/opl/build",title:"Build",description:"Now that we have written our two smart contracts, let's compile and deploy them!",source:"@site/docs/dapp/opl/build.md",sourceDirName:"dapp/opl",slug:"/dapp/opl/build",permalink:"/dapp/opl/build",draft:!1,unlisted:!1,editUrl:"https://github.com/oasisprotocol/docs/edit/main/docs/dapp/opl/build.md",tags:[],version:"current",lastUpdatedAt:1723018842e3,frontMatter:{},sidebar:"developers",previous:{title:"Ballot Contract",permalink:"/dapp/opl/enclave"},next:{title:"Frontend Application",permalink:"/dapp/opl/frontend"}},d={},h=[{value:"Compiling",id:"compiling",level:3},{value:"Deploying",id:"deploying",level:3},{value:"Localhost",id:"localhost",level:4},{value:"Testnet",id:"testnet",level:4}];function u(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h3:"h3",h4:"h4",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.h1,{id:"build",children:"Build"}),"\n",(0,a.jsx)(n.p,{children:"Now that we have written our two smart contracts, let's compile and deploy them!"}),"\n",(0,a.jsx)(n.h3,{id:"compiling",children:"Compiling"}),"\n",(0,a.jsx)(n.p,{children:"Compile both the host and enclave smart contracts by invoking:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"npx hardhat compile\n"})}),"\n",(0,a.jsx)(n.h3,{id:"deploying",children:"Deploying"}),"\n",(0,a.jsxs)(n.p,{children:["We can make deployments easier by using ",(0,a.jsx)(n.a,{href:"https://github.com/wighawag/hardhat-deploy",children:"Hardhat deploy"}),"."]}),"\n",(0,a.jsxs)(r.A,{groupId:"npm2yarn",children:[(0,a.jsx)(l.A,{value:"npm",children:(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"npm install -D hardhat-deploy\n"})})}),(0,a.jsx)(l.A,{value:"pnpm",label:"pnpm",children:(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"pnpm add -D hardhat-deploy\n"})})}),(0,a.jsx)(l.A,{value:"yarn",label:"Yarn",children:(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"yarn add --dev hardhat-deploy\n"})})})]}),"\n",(0,a.jsxs)(n.p,{children:["Add the following configuration changes to your ",(0,a.jsx)(n.code,{children:"hardhat.config.ts"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-diff",children:"diff --git a/backend/hardhat.config.ts b/backend/hardhat.config.ts\nindex cd8df42..0875e8e 100644\n--- a/backend/hardhat.config.ts\n+++ b/backend/hardhat.config.ts\n@@ -1,8 +1,70 @@\n-import { HardhatUserConfig } from \"hardhat/config\";\n+import '@oasisprotocol/sapphire-hardhat';\n import \"@nomicfoundation/hardhat-toolbox\";\n+import { HardhatUserConfig, task } from 'hardhat/config';\n+\n+const accounts = process.env.PRIVATE_KEY ? [process.env.PRIVATE_KEY] : [];\n+\n+task('deploy-ballot-box')\n+  .addParam('hostNetwork')\n+  .setAction(async (args, hre) => {\n+    await hre.run('compile');\n+    const ethers = hre.ethers;\n+    const BallotBoxV1 = await ethers.getContractFactory('BallotBoxV1');\n+    const signer = ethers.provider.getSigner();\n+    const signerAddr = await signer.getAddress();\n+\n+    // Start by predicting the address of the DAO contract.\n+    const hostConfig = hre.config.networks[args.hostNetwork];\n+    if (!('url' in hostConfig)) throw new Error(`${args.hostNetwork} not configured`);\n+    const provider = new ethers.providers.JsonRpcProvider(hostConfig.url);\n+    let nonce = await provider.getTransactionCount(signerAddr);\n+    if (args.hostNetwork === 'local') nonce++;\n+    const daoAddr = ethers.utils.getContractAddress({ from: signerAddr, nonce });\n+\n+    const ballotBox = await BallotBoxV1.deploy(daoAddr);\n+    await ballotBox.deployed();\n+    console.log('expected DAO', daoAddr);\n+    console.log('BallotBox', ballotBox.address);\n+    return ballotBox.address;\n+  });\n+\n+task('deploy-dao')\n+  .addParam('ballotBoxAddr')\n+  .setAction(async (args, hre) => {\n+    await hre.run('compile');\n+    const DAOV1 = await hre.ethers.getContractFactory('DAOV1');\n+    const dao = await DAOV1.deploy(args.ballotBoxAddr);\n+    await dao.deployed();\n+    console.log('DAO', dao.address);\n+    return dao;\n+  });\n+\n+task('deploy-local').setAction(async (_args, hre) => {\n+    await hre.run('compile');\n+    const ballotBox = await hre.run('deploy-ballot-box', { hostNetwork: 'local' });\n+    await hre.run('deploy-dao', { ballotBoxAddr: ballotBox });\n+  });\n \n const config: HardhatUserConfig = {\n   solidity: \"0.8.18\",\n+  networks: {\n+    hardhat: {\n+      chainId: 1337, // @see https://hardhat.org/metamask-issue.html\n+    },\n+    local: {\n+      url: 'http://127.0.0.1:8545',\n+    },\n+    'bsc-testnet': {\n+      url: 'https://data-seed-prebsc-1-s1.binance.org:8545',\n+      chainId: 97,\n+      accounts,\n+    },\n+    'sapphire-testnet': {\n+      url: 'https://testnet.sapphire.oasis.io',\n+      chainId: 0x5aff,\n+      accounts,\n+    },\n+  }\n };\n \n export default config;\n"})}),"\n",(0,a.jsx)(n.h4,{id:"localhost",children:"Localhost"}),"\n",(0,a.jsx)(n.p,{children:"We can start local Hardhat node again:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"npx hardhat node\n"})}),"\n",(0,a.jsx)(n.p,{children:"Our deploy should succeed locally."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"npx hardhat deploy-local --network localhost\nNothing to compile\nNo need to generate any newer typings.\nNothing to compile\nNo need to generate any newer typings.\nexpected DAO 0xa513E6E4b8f2a923D98304ec87F64353C4D5C853\nBallotBox 0x0165878A594ca255338adfa4d48449f69242Eb8F\nNothing to compile\nNo need to generate any newer typings.\nDAO 0xa513E6E4b8f2a923D98304ec87F64353C4D5C853\n"})}),"\n",(0,a.jsx)(n.p,{children:"We will use these addresses in our frontend application."}),"\n",(0,a.jsx)(n.h4,{id:"testnet",children:"Testnet"}),"\n",(0,a.jsxs)(n.p,{children:["We can likewise deploy to ",(0,a.jsx)(n.a,{href:"../../dapp/sapphire/guide#testnet-and-mainnet",children:"Testnet"}),"\nwith Sapphire."]}),"\n",(0,a.jsxs)(n.p,{children:["In this case, we should prepare a wallet with Testnet tokens on both BNB Smart\nChain ",(0,a.jsx)(n.a,{href:"https://testnet.bnbchain.org/faucet-smart",children:"Faucet"})," and Sapphire ",(0,a.jsx)(n.a,{href:"https://faucet.testnet.oasis.io",children:"faucet"}),"."]}),"\n",(0,a.jsx)(n.p,{children:"We will use a common private key for both the host and enclave smart contracts."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"export PRIVATE_KEY=\n"})}),"\n",(0,a.jsx)(n.p,{children:"Deploy the enclave smart contract using Testnet parameters."}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"npx hardhat deploy-ballot-box --network sapphire-testnet --host-network bsc-testnet\nNothing to compile\nNo need to generate any newer typings.\nexpected DAO 0xFBcb580DD6D64fbF7caF57FB0439502412324179\nBallotBox 0xFb40591a8df155da291A4B52E4Df9901a95b7C06\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Next, use the obtained ",(0,a.jsx)(n.code,{children:"BallotBox"})," address below to deploy the host smart\ncontract:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-shell",children:"npx hardhat deploy-dao --network bsc-testnet --ballot-box-addr {BALLOT_BOX_ADDR}\nNothing to compile\nNo need to generate any newer typings.\nDAO 0xFBcb580DD6D64fbF7caF57FB0439502412324179\n"})}),"\n",(0,a.jsx)(n.admonition,{title:"Example",type:"info",children:(0,a.jsxs)(n.p,{children:["You can try out and download a complete backend example with both host and\nenclave smart contracts from the\n",(0,a.jsx)(n.a,{href:"https://github.com/oasisprotocol/demo-opl-secret-ballot/tree/main/backend",children:"Oasis Playground repository"}),"."]})})]})}function p(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(u,{...e})}):u(e)}},9365:(e,n,t)=>{t.d(n,{A:()=>l});t(6540);var a=t(4164);const o={tabItem:"tabItem_Ymn6"};var r=t(4848);function l(e){let{children:n,hidden:t,className:l}=e;return(0,r.jsx)("div",{role:"tabpanel",className:(0,a.A)(o.tabItem,l),hidden:t,children:n})}},1470:(e,n,t)=>{t.d(n,{A:()=>j});var a=t(6540),o=t(4164),r=t(3104),l=t(6347),s=t(205),i=t(7485),c=t(1682),d=t(9466);function h(e){return a.Children.toArray(e).filter((e=>"\n"!==e)).map((e=>{if(!e||(0,a.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}function u(e){const{values:n,children:t}=e;return(0,a.useMemo)((()=>{const e=n??function(e){return h(e).map((e=>{let{props:{value:n,label:t,attributes:a,default:o}}=e;return{value:n,label:t,attributes:a,default:o}}))}(t);return function(e){const n=(0,c.X)(e,((e,n)=>e.value===n.value));if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[n,t])}function p(e){let{value:n,tabValues:t}=e;return t.some((e=>e.value===n))}function m(e){let{queryString:n=!1,groupId:t}=e;const o=(0,l.W6)(),r=function(e){let{queryString:n=!1,groupId:t}=e;if("string"==typeof n)return n;if(!1===n)return null;if(!0===n&&!t)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return t??null}({queryString:n,groupId:t});return[(0,i.aZ)(r),(0,a.useCallback)((e=>{if(!r)return;const n=new URLSearchParams(o.location.search);n.set(r,e),o.replace({...o.location,search:n.toString()})}),[r,o])]}function g(e){const{defaultValue:n,queryString:t=!1,groupId:o}=e,r=u(e),[l,i]=(0,a.useState)((()=>function(e){let{defaultValue:n,tabValues:t}=e;if(0===t.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(n){if(!p({value:n,tabValues:t}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${n}" but none of its children has the corresponding value. Available values are: ${t.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return n}const a=t.find((e=>e.default))??t[0];if(!a)throw new Error("Unexpected error: 0 tabValues");return a.value}({defaultValue:n,tabValues:r}))),[c,h]=m({queryString:t,groupId:o}),[g,b]=function(e){let{groupId:n}=e;const t=function(e){return e?`docusaurus.tab.${e}`:null}(n),[o,r]=(0,d.Dv)(t);return[o,(0,a.useCallback)((e=>{t&&r.set(e)}),[t,r])]}({groupId:o}),f=(()=>{const e=c??g;return p({value:e,tabValues:r})?e:null})();(0,s.A)((()=>{f&&i(f)}),[f]);return{selectedValue:l,selectValue:(0,a.useCallback)((e=>{if(!p({value:e,tabValues:r}))throw new Error(`Can't select invalid tab value=${e}`);i(e),h(e),b(e)}),[h,b,r]),tabValues:r}}var b=t(2303);const f={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var x=t(4848);function y(e){let{className:n,block:t,selectedValue:a,selectValue:l,tabValues:s}=e;const i=[],{blockElementScrollPositionUntilNextRender:c}=(0,r.a_)(),d=e=>{const n=e.currentTarget,t=i.indexOf(n),o=s[t].value;o!==a&&(c(n),l(o))},h=e=>{let n=null;switch(e.key){case"Enter":d(e);break;case"ArrowRight":{const t=i.indexOf(e.currentTarget)+1;n=i[t]??i[0];break}case"ArrowLeft":{const t=i.indexOf(e.currentTarget)-1;n=i[t]??i[i.length-1];break}}n?.focus()};return(0,x.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,o.A)("tabs",{"tabs--block":t},n),children:s.map((e=>{let{value:n,label:t,attributes:r}=e;return(0,x.jsx)("li",{role:"tab",tabIndex:a===n?0:-1,"aria-selected":a===n,ref:e=>i.push(e),onKeyDown:h,onClick:d,...r,className:(0,o.A)("tabs__item",f.tabItem,r?.className,{"tabs__item--active":a===n}),children:t??n},n)}))})}function v(e){let{lazy:n,children:t,selectedValue:o}=e;const r=(Array.isArray(t)?t:[t]).filter(Boolean);if(n){const e=r.find((e=>e.props.value===o));return e?(0,a.cloneElement)(e,{className:"margin-top--md"}):null}return(0,x.jsx)("div",{className:"margin-top--md",children:r.map(((e,n)=>(0,a.cloneElement)(e,{key:n,hidden:e.props.value!==o})))})}function w(e){const n=g(e);return(0,x.jsxs)("div",{className:(0,o.A)("tabs-container",f.tabList),children:[(0,x.jsx)(y,{...n,...e}),(0,x.jsx)(v,{...n,...e})]})}function j(e){const n=(0,b.A)();return(0,x.jsx)(w,{...e,children:h(e.children)},String(n))}},8453:(e,n,t)=>{t.d(n,{R:()=>l,x:()=>s});var a=t(6540);const o={},r=a.createContext(o);function l(e){const n=a.useContext(r);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:l(e.components),a.createElement(r.Provider,{value:n},e.children)}}}]);